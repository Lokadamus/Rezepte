<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pichlhofers Rezeptsammlung</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7Uv_0w7T4NZSlUQsOw9MJ8irOYB51kbk",
      authDomain: "pichlhofer-rezepte.firebaseapp.com",
      projectId: "pichlhofer-rezepte",
      storageBucket: "pichlhofer-rezepte.firebasestorage.app",
      messagingSenderId: "616466355086",
      appId: "1:616466355086:web:9fb3256c9deec444650adf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.firebaseDB = db;
    window.firebaseCollection = collection;
    window.firebaseGetDocs = getDocs;
    window.firebaseSetDoc = setDoc;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseDoc = doc;
    window.firebaseReady = true;

    // Trigger load after Firebase is ready
    if (window.onFirebaseReady) window.onFirebaseReady();
  </script>
  <style>
    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .login-screen.hidden { display: none; }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 340px;
      text-align: center;
    }
    .login-box h1 {
      font-size: 24px;
      margin-bottom: 30px;
      color: #1d1d1f;
    }
    .login-box select,
    .login-box input {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 16px;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .login-box select:focus,
    .login-box input:focus {
      outline: none;
      border-color: #0071e3;
    }
    .login-box .btn-primary {
      width: 100%;
      padding: 14px;
      margin-top: 8px;
    }
    .login-error {
      color: #ff3b30;
      font-size: 14px;
      margin-top: 16px;
      min-height: 20px;
    }
    .logout-btn {
      background: none;
      border: none;
      color: #86868b;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 12px;
    }
    .logout-btn:hover { color: #1d1d1f; }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 20px;
      overflow-y: auto;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { font-size: 1.25rem; margin: 0; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #86868b;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: #1d1d1f; }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 6px;
      color: #1d1d1f;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      font-size: 1rem;
      font-family: inherit;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #f5f5f7;
      transition: all 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0071e3;
      background: white;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-hint { font-size: 0.75rem; color: #86868b; margin-top: 4px; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e5e5;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-secondary { background: #e5e5e5; color: #1d1d1f; }
    .btn-secondary:hover { background: #d2d2d7; }
    .btn-blue { background: #0071e3; color: white; }
    .btn-blue:hover { background: #0077ed; }

    /* Add Button */
    .add-recipe-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #0071e3;
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,113,227,0.4);
      transition: all 0.2s;
      z-index: 100;
    }
    .add-recipe-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0,113,227,0.5);
    }

    /* Action Buttons in Header */
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .btn-icon {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #86868b;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .btn-icon:hover { background: #f5f5f7; color: #1d1d1f; }

    /* Dynamic ingredient/step rows */
    .dynamic-list { margin-top: 8px; }
    .dynamic-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .dynamic-row input { flex: 1; }
    .dynamic-row .remove-btn {
      background: none;
      border: none;
      color: #ff3b30;
      cursor: pointer;
      font-size: 1.25rem;
      padding: 4px 8px;
    }
    .add-row-btn {
      background: none;
      border: 1px dashed #d2d2d7;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      color: #0071e3;
      font-size: 0.875rem;
      width: 100%;
      transition: all 0.2s;
    }
    .add-row-btn:hover { background: #f5f5f7; border-color: #0071e3; }

    /* Image Upload */
    .image-upload-row {
      display: flex;
      gap: 10px;
    }
    .image-upload-row input[type="text"] {
      flex: 1;
    }
    .upload-btn {
      background: #0071e3;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9375rem;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .upload-btn:hover { background: #0077ed; }
    .upload-btn.uploading {
      background: #86868b;
      cursor: wait;
    }
    .upload-btn.success {
      background: #34c759;
    }

    /* Week Button */
    .week-btn {
      background: #34c759;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 980px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .week-btn:hover { background: #2db84d; transform: scale(1.05); }

    /* Week Plan Modal */
    .week-plan {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .week-plan.active { display: flex; }
    .week-plan-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .week-plan-header {
      padding: 20px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .week-plan-header h2 { margin: 0; font-size: 1.25rem; }
    .week-plan-body { padding: 0; }
    .week-day {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .week-day:hover { background: #f5f5f7; }
    .week-day:last-child { border-bottom: none; }
    .week-day-name {
      font-weight: 600;
      color: #86868b;
      font-size: 0.875rem;
      min-width: 80px;
    }
    .week-day-recipe {
      flex: 1;
      font-weight: 500;
      color: #1d1d1f;
    }
    .week-day-time {
      font-size: 0.875rem;
      color: #86868b;
    }
    .week-plan-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 12px;
    }
    .week-plan-footer button { flex: 1; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>Pichlhofers Rezepte</h1>
      <form onsubmit="handleLogin(event)">
        <input type="text" id="login-user" placeholder="Benutzername" required>
        <input type="password" id="login-password" placeholder="Passwort" required>
        <button type="submit" class="btn-primary">Anmelden</button>
        <p id="login-error" class="login-error"></p>
      </form>
    </div>
  </div>

  <!-- App Container (hidden until login) -->
  <div id="app-container" style="display: none;">
  <header class="site-header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="site-title" onclick="showHome(); return false;">Rezepte</a>
        <button class="week-btn" onclick="showWeekPlan()">7 Tage</button>
        <div class="header-actions">
          <div class="search-wrapper">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" class="search-input" id="search" placeholder="Suchen..." autocomplete="off">
          </div>
          <button class="btn-icon" onclick="exportRecipes()" title="Rezepte exportieren">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
          </button>
          <button class="btn-icon" onclick="importFromJSON()" title="Aus JSON importieren" id="import-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
          </button>
          <button class="logout-btn" onclick="handleLogout()" id="logout-btn">Abmelden</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Home View -->
    <div id="home-view">
      <section class="hero">
        <div class="container">
          <h1>Pichlhofers Rezeptsammlung</h1>
          <p>Mit Liebe gesammelt, einfach nachzukochen.</p>
        </div>
      </section>

      <div class="container">
        <nav class="category-filter">
          <button class="category-pill active" data-category="alle">Alle</button>
          <button class="category-pill" data-category="vorspeisen">Vorspeisen</button>
          <button class="category-pill" data-category="hauptspeisen">Hauptspeisen</button>
          <button class="category-pill" data-category="desserts">Desserts</button>
        </nav>

        <div class="recipe-grid" id="recipe-grid">
          <!-- Recipes loaded via JavaScript -->
        </div>
      </div>
    </div>

    <!-- Recipe Detail View -->
    <div id="recipe-view" style="display: none;">
      <div class="recipe-hero" id="recipe-hero">
        <div class="recipe-hero-overlay">
          <div class="container">
            <h1 id="recipe-title"></h1>
          </div>
        </div>
      </div>

      <div class="recipe-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
          <a href="#" class="back-link" onclick="showHome(); return false;">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Alle Rezepte
          </a>
          <div style="display: flex; gap: 8px;">
            <button class="btn-icon" onclick="editRecipe()" title="Rezept bearbeiten" id="edit-btn">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button class="btn-icon" onclick="deleteRecipe()" title="Rezept l√∂schen" id="delete-btn" style="color: #ff3b30;">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="recipe-meta-bar" id="recipe-meta"></div>

        <p id="recipe-description" style="font-size: 1.125rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);"></p>

        <section class="recipe-section">
          <h2>Zutaten</h2>
          <ul class="ingredients-list" id="recipe-ingredients"></ul>
          <div style="display: flex; gap: 12px; margin-top: var(--spacing-lg);">
            <button class="btn-primary" style="flex: 1; background: #25D366;" onclick="sendShoppingListWhatsApp()">
              <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              WhatsApp
            </button>
            <button class="btn-primary" style="flex: 1;" onclick="printShoppingList()">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
              </svg>
              Drucken
            </button>
          </div>
        </section>

        <section class="recipe-section">
          <h2>Zubereitung</h2>
          <ol class="instructions-list" id="recipe-instructions"></ol>
        </section>

        <section class="recipe-section" id="recipe-tips-section" style="display: none;">
          <h2>Tipps</h2>
          <p id="recipe-tips"></p>
        </section>
      </div>
    </div>
  </main>

  <!-- Add Recipe Button -->
  <button class="add-recipe-btn" onclick="openModal()" title="Neues Rezept">+</button>

  <!-- Add Recipe Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Neues Rezept</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="recipe-form">
          <div class="form-group">
            <label>Rezeptname *</label>
            <input type="text" id="form-title" required placeholder="z.B. Omas Apfelkuchen">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Kategorie *</label>
              <select id="form-kategorie" required>
                <option value="Vorspeisen">Vorspeisen</option>
                <option value="Hauptspeisen" selected>Hauptspeisen</option>
                <option value="Desserts">Desserts</option>
              </select>
            </div>
            <div class="form-group">
              <label>Schwierigkeit</label>
              <select id="form-schwierigkeit">
                <option value="Einfach">Einfach</option>
                <option value="Mittel">Mittel</option>
                <option value="Schwer">Schwer</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Zubereitungszeit</label>
              <input type="text" id="form-zeit" placeholder="z.B. 45 Min">
            </div>
            <div class="form-group">
              <label>Portionen</label>
              <input type="text" id="form-portionen" placeholder="z.B. 4">
            </div>
          </div>

          <div class="form-group">
            <label>Kurzbeschreibung</label>
            <input type="text" id="form-beschreibung" placeholder="Ein Satz zum Gericht...">
          </div>

          <div class="form-group">
            <label>Bild (optional)</label>
            <div class="image-upload-row">
              <input type="text" id="form-bild" placeholder="URL wird automatisch eingef√ºgt...">
              <label class="upload-btn" id="upload-label">
                <input type="file" id="form-bild-file" accept="image/*" onchange="uploadImage(this)" hidden>
                <span id="upload-btn-text">Foto w√§hlen</span>
              </label>
            </div>
            <p class="form-hint" id="upload-hint">Foto vom Handy oder Computer hochladen</p>
          </div>

          <div class="form-group">
            <label>Zutaten *</label>
            <div class="dynamic-list" id="zutaten-list">
              <div class="dynamic-row">
                <input type="text" placeholder="Menge (z.B. 500g)" class="zutat-menge">
                <input type="text" placeholder="Zutat (z.B. Mehl)" class="zutat-name">
                <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
              </div>
            </div>
            <button type="button" class="add-row-btn" onclick="addZutatRow()">+ Zutat hinzuf√ºgen</button>
          </div>

          <div class="form-group">
            <label>Zubereitung *</label>
            <div class="dynamic-list" id="zubereitung-list">
              <div class="dynamic-row">
                <input type="text" placeholder="Schritt 1..." class="schritt">
                <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
              </div>
            </div>
            <button type="button" class="add-row-btn" onclick="addSchrittRow()">+ Schritt hinzuf√ºgen</button>
          </div>

          <div class="form-group">
            <label>Tipps (optional)</label>
            <textarea id="form-tipps" placeholder="Hilfreiche Tipps zum Rezept..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
        <button class="btn btn-blue" onclick="saveRecipe()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Week Plan Modal -->
  <div class="week-plan" id="week-plan-modal">
    <div class="week-plan-content">
      <div class="week-plan-header">
        <h2>Wochenplan</h2>
        <button class="modal-close" onclick="closeWeekPlan()">&times;</button>
      </div>
      <div class="week-plan-body" id="week-plan-body">
        <!-- Days will be inserted here -->
      </div>
      <div class="week-plan-footer">
        <button class="btn btn-secondary" onclick="generateWeekPlan()">Neu w√ºrfeln</button>
        <button class="btn btn-blue" onclick="printWeekPlan()">Drucken</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container">
      <p>Pichlhofers Rezeptsammlung &copy; 2025</p>
    </div>
  </footer>

  <script>
    // Authentication
    const VALID_USERS = ['Sven', 'Christa', 'Marc', 'Markus'];
    const VALID_PASSWORD = 'Duffduff133!';

    function checkAuth() {
      const loggedIn = sessionStorage.getItem('rezepte-auth');
      if (loggedIn) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').style.display = 'block';
        return true;
      }
      return false;
    }

    function handleLogin(e) {
      e.preventDefault();
      const user = document.getElementById('login-user').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');

      if (VALID_USERS.map(u => u.toLowerCase()).includes(user.toLowerCase()) && password === VALID_PASSWORD) {
        sessionStorage.setItem('rezepte-auth', user);
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').style.display = 'block';
        errorEl.textContent = '';
      } else {
        errorEl.textContent = 'Falsches Passwort!';
      }
    }

    function handleLogout() {
      sessionStorage.removeItem('rezepte-auth');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('login-password').value = '';
    }

    // Check auth on page load
    checkAuth();

    let rezepte = [];
    let currentRecipe = null;

    // Load recipes from Firebase
    async function loadRecipes() {
      // Wait for Firebase to be ready
      if (!window.firebaseReady) {
        window.onFirebaseReady = loadRecipes;
        return;
      }

      try {
        showNotification('Lade Rezepte...', 'success');
        const querySnapshot = await window.firebaseGetDocs(
          window.firebaseCollection(window.firebaseDB, 'rezepte')
        );

        rezepte = [];
        querySnapshot.forEach((doc) => {
          rezepte.push({ id: doc.id, ...doc.data() });
        });

        // Sort by title
        rezepte.sort((a, b) => a.title.localeCompare(b.title));
        renderRecipeGrid(rezepte);

        // Hide notification
        const notif = document.querySelector('.notification');
        if (notif) notif.remove();

      } catch (error) {
        console.error('Fehler beim Laden:', error);
        showNotification('Fehler beim Laden der Rezepte', 'error');
        rezepte = [];
        renderRecipeGrid(rezepte);
      }
    }

    // Save single recipe to Firebase
    async function saveRecipeToFirebase(recipe) {
      try {
        await window.firebaseSetDoc(
          window.firebaseDoc(window.firebaseDB, 'rezepte', recipe.id),
          recipe
        );
        showNotification('Gespeichert!', 'success');
        return true;
      } catch (error) {
        console.error('Speicherfehler:', error);
        showNotification('Fehler beim Speichern!', 'error');
        return false;
      }
    }

    // Delete recipe from Firebase
    async function deleteRecipeFromFirebase(recipeId) {
      try {
        await window.firebaseDeleteDoc(
          window.firebaseDoc(window.firebaseDB, 'rezepte', recipeId)
        );
        return true;
      } catch (error) {
        console.error('L√∂schfehler:', error);
        showNotification('Fehler beim L√∂schen!', 'error');
        return false;
      }
    }

    // Legacy function for compatibility
    async function saveToStorage() {
      // Not used with Firebase, but kept for compatibility
    }

    // Notification
    function showNotification(message, type) {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      const div = document.createElement('div');
      div.className = 'notification';
      div.style.cssText = `
        position: fixed;
        bottom: 100px;
        right: 30px;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 500;
        z-index: 2000;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#34c759' : '#ff3b30'};
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      `;
      div.textContent = message;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // Render recipe cards
    function renderRecipeGrid(recipes) {
      const grid = document.getElementById('recipe-grid');

      if (recipes.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1/-1;">Keine Rezepte gefunden. Klicke auf + um ein Rezept hinzuzuf√ºgen.</p>';
        return;
      }

      grid.innerHTML = recipes.map(recipe => `
        <div class="recipe-card" data-category="${recipe.kategorie.toLowerCase()}" onclick="showRecipe('${recipe.id}')">
          <div class="recipe-card-image">
            ${recipe.bild
              ? `<img src="${recipe.bild}" alt="${recipe.title}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'><span>${recipe.title.charAt(0)}</span></div>'">`
              : `<div class="no-image"><span>${recipe.title.charAt(0)}</span></div>`
            }
          </div>
          <div class="recipe-card-content">
            <h3 class="recipe-card-title">${recipe.title}</h3>
            <div class="recipe-card-meta">
              ${recipe.zeit ? `
              <span>
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${recipe.zeit}
              </span>
              ` : ''}
              <span>${recipe.kategorie}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Show recipe detail
    function showRecipe(id) {
      const recipe = rezepte.find(r => r.id === id);
      if (!recipe) return;

      currentRecipe = recipe;

      // Show delete button
      document.getElementById('delete-btn').style.display = '';

      // Set hero image
      const hero = document.getElementById('recipe-hero');
      if (recipe.bild) {
        hero.innerHTML = `
          <img src="${recipe.bild}" alt="${recipe.title}" onerror="this.style.display='none'">
          <div class="recipe-hero-overlay">
            <div class="container">
              <h1>${recipe.title}</h1>
            </div>
          </div>
        `;
      } else {
        hero.innerHTML = `
          <div class="no-image" style="height: 100%;"><span style="font-size: 5rem;">${recipe.title.charAt(0)}</span></div>
          <div class="recipe-hero-overlay">
            <div class="container">
              <h1>${recipe.title}</h1>
            </div>
          </div>
        `;
      }

      // Set meta info
      document.getElementById('recipe-meta').innerHTML = `
        ${recipe.zeit ? `<div class="recipe-meta-item"><span class="label">Zubereitungszeit</span><span class="value">${recipe.zeit}</span></div>` : ''}
        ${recipe.portionen ? `<div class="recipe-meta-item"><span class="label">Portionen</span><span class="value">${recipe.portionen}</span></div>` : ''}
        ${recipe.schwierigkeit ? `<div class="recipe-meta-item"><span class="label">Schwierigkeit</span><span class="value">${recipe.schwierigkeit}</span></div>` : ''}
        ${recipe.kategorie ? `<div class="recipe-meta-item"><span class="label">Kategorie</span><span class="value">${recipe.kategorie}</span></div>` : ''}
      `;

      // Set description
      document.getElementById('recipe-description').textContent = recipe.beschreibung || '';

      // Set ingredients
      document.getElementById('recipe-ingredients').innerHTML = recipe.zutaten.map(z => `
        <li>
          <span class="ingredient-name">${z.name}</span>
          <span class="ingredient-amount">${z.menge}</span>
        </li>
      `).join('');

      // Set instructions
      document.getElementById('recipe-instructions').innerHTML = recipe.zubereitung.map(s => `<li>${s}</li>`).join('');

      // Set tips
      if (recipe.tipps) {
        document.getElementById('recipe-tips').textContent = recipe.tipps;
        document.getElementById('recipe-tips-section').style.display = '';
      } else {
        document.getElementById('recipe-tips-section').style.display = 'none';
      }

      // Show recipe view
      document.getElementById('home-view').style.display = 'none';
      document.getElementById('recipe-view').style.display = '';
      window.scrollTo(0, 0);
    }

    // Show home view
    function showHome() {
      document.getElementById('home-view').style.display = '';
      document.getElementById('recipe-view').style.display = 'none';
      currentRecipe = null;
      renderRecipeGrid(rezepte);
    }

    // Delete recipe
    async function deleteRecipe() {
      if (!currentRecipe) return;

      if (confirm(`"${currentRecipe.title}" wirklich l√∂schen?`)) {
        const success = await deleteRecipeFromFirebase(currentRecipe.id);
        if (success) {
          rezepte = rezepte.filter(r => r.id !== currentRecipe.id);
          showNotification('Gel√∂scht!', 'success');
          showHome();
        }
      }
    }

    // Send shopping list via WhatsApp
    function sendShoppingListWhatsApp() {
      if (!currentRecipe) return;

      // Format shopping list as text
      const items = currentRecipe.zutaten
        .map(z => `‚Ä¢ ${z.name} - ${z.menge}`)
        .join('\n');

      const message = `üõí *Einkaufsliste*\n${currentRecipe.title} (${currentRecipe.portionen} Portionen)\n\n${items}`;

      // Open WhatsApp with pre-filled message
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    // Print shopping list
    function printShoppingList() {
      if (!currentRecipe) return;

      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Einkaufsliste - ${currentRecipe.title}</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 40px; max-width: 500px; }
            h1 { font-size: 24px; margin-bottom: 8px; }
            h2 { font-size: 14px; color: #666; font-weight: normal; margin-bottom: 24px; }
            ul { list-style: none; padding: 0; }
            li { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
            .menge { color: #666; }
          </style>
        </head>
        <body>
          <h1>Einkaufsliste</h1>
          <h2>${currentRecipe.title} - ${currentRecipe.portionen} Portionen</h2>
          <ul>
            ${currentRecipe.zutaten.map(z => `<li><span>${z.name}</span><span class="menge">${z.menge}</span></li>`).join('')}
          </ul>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    // Export all recipes as JSON
    function exportRecipes() {
      const dataStr = JSON.stringify(rezepte, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rezepte.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Modal functions
    let editingRecipeId = null;

    function openModal() {
      editingRecipeId = null;
      document.querySelector('.modal-header h2').textContent = 'Neues Rezept';
      document.getElementById('modal').classList.add('active');
      document.getElementById('form-title').focus();
    }

    function editRecipe() {
      if (!currentRecipe) return;

      editingRecipeId = currentRecipe.id;
      document.querySelector('.modal-header h2').textContent = 'Rezept bearbeiten';

      // Fill form with current recipe data
      document.getElementById('form-title').value = currentRecipe.title;
      document.getElementById('form-kategorie').value = currentRecipe.kategorie;
      document.getElementById('form-schwierigkeit').value = currentRecipe.schwierigkeit || 'Einfach';
      document.getElementById('form-zeit').value = currentRecipe.zeit || '';
      document.getElementById('form-portionen').value = currentRecipe.portionen || '';
      document.getElementById('form-beschreibung').value = currentRecipe.beschreibung || '';
      // Show image path - keep URLs as-is, show only filename for local images
      let bildValue = currentRecipe.bild || '';
      if (bildValue.startsWith('assets/images/')) {
        bildValue = bildValue.replace('assets/images/', '');
      }
      // Keep full URLs unchanged
      document.getElementById('form-bild').value = bildValue;
      document.getElementById('form-tipps').value = currentRecipe.tipps || '';

      // Fill ingredients
      const zutatenList = document.getElementById('zutaten-list');
      zutatenList.innerHTML = currentRecipe.zutaten.map(z => `
        <div class="dynamic-row">
          <input type="text" placeholder="Menge" class="zutat-menge" value="${z.menge || ''}">
          <input type="text" placeholder="Zutat" class="zutat-name" value="${z.name || ''}">
          <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
        </div>
      `).join('');

      // Fill steps
      const zubereitungList = document.getElementById('zubereitung-list');
      zubereitungList.innerHTML = currentRecipe.zubereitung.map((s, i) => `
        <div class="dynamic-row">
          <input type="text" placeholder="Schritt ${i+1}..." class="schritt" value="${s}">
          <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
        </div>
      `).join('');

      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      editingRecipeId = null;
      document.getElementById('modal').classList.remove('active');
      document.getElementById('recipe-form').reset();
      // Reset dynamic lists
      document.getElementById('zutaten-list').innerHTML = `
        <div class="dynamic-row">
          <input type="text" placeholder="Menge (z.B. 500g)" class="zutat-menge">
          <input type="text" placeholder="Zutat (z.B. Mehl)" class="zutat-name">
          <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
        </div>
      `;
      document.getElementById('zubereitung-list').innerHTML = `
        <div class="dynamic-row">
          <input type="text" placeholder="Schritt 1..." class="schritt">
          <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
        </div>
      `;
    }

    // Image Upload to ImgBB
    const IMGBB_API_KEY = '31955502dda578a20355e36b06d783d1';

    async function uploadImage(input) {
      const file = input.files[0];
      if (!file) return;

      const uploadBtn = document.getElementById('upload-label');
      const uploadText = document.getElementById('upload-btn-text');
      const hint = document.getElementById('upload-hint');

      // Show uploading state
      uploadBtn.classList.add('uploading');
      uploadText.textContent = 'L√§dt...';
      hint.textContent = 'Bild wird hochgeladen...';

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('form-bild').value = data.data.url;
          uploadBtn.classList.remove('uploading');
          uploadBtn.classList.add('success');
          uploadText.textContent = 'Fertig!';
          hint.textContent = 'Bild erfolgreich hochgeladen!';

          // Reset button after 2 seconds
          setTimeout(() => {
            uploadBtn.classList.remove('success');
            uploadText.textContent = 'Foto w√§hlen';
          }, 2000);
        } else {
          throw new Error(data.error?.message || 'Upload fehlgeschlagen');
        }
      } catch (error) {
        console.error('Upload-Fehler:', error);
        uploadBtn.classList.remove('uploading');
        uploadText.textContent = 'Foto w√§hlen';
        hint.textContent = 'Fehler beim Upload. Bitte erneut versuchen.';
        hint.style.color = '#ff3b30';

        setTimeout(() => {
          hint.textContent = 'Foto vom Handy oder Computer hochladen';
          hint.style.color = '';
        }, 3000);
      }

      // Reset file input
      input.value = '';
    }

    // Dynamic form rows
    function addZutatRow() {
      const list = document.getElementById('zutaten-list');
      const row = document.createElement('div');
      row.className = 'dynamic-row';
      row.innerHTML = `
        <input type="text" placeholder="Menge" class="zutat-menge">
        <input type="text" placeholder="Zutat" class="zutat-name">
        <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
      `;
      list.appendChild(row);
      row.querySelector('.zutat-menge').focus();
    }

    function addSchrittRow() {
      const list = document.getElementById('zubereitung-list');
      const count = list.querySelectorAll('.dynamic-row').length + 1;
      const row = document.createElement('div');
      row.className = 'dynamic-row';
      row.innerHTML = `
        <input type="text" placeholder="Schritt ${count}..." class="schritt">
        <button type="button" class="remove-btn" onclick="removeRow(this)">&times;</button>
      `;
      list.appendChild(row);
      row.querySelector('.schritt').focus();
    }

    function removeRow(btn) {
      const row = btn.parentElement;
      const list = row.parentElement;
      if (list.querySelectorAll('.dynamic-row').length > 1) {
        row.remove();
      }
    }

    // Save recipe (new or edited)
    async function saveRecipe() {
      const title = document.getElementById('form-title').value.trim();
      if (!title) {
        alert('Bitte gib einen Rezeptnamen ein.');
        return;
      }

      // Collect ingredients
      const zutaten = [];
      document.querySelectorAll('#zutaten-list .dynamic-row').forEach(row => {
        const menge = row.querySelector('.zutat-menge').value.trim();
        const name = row.querySelector('.zutat-name').value.trim();
        if (name) {
          zutaten.push({ name, menge });
        }
      });

      if (zutaten.length === 0) {
        alert('Bitte gib mindestens eine Zutat ein.');
        return;
      }

      // Collect steps
      const zubereitung = [];
      document.querySelectorAll('#zubereitung-list .schritt').forEach(input => {
        const step = input.value.trim();
        if (step) {
          zubereitung.push(step);
        }
      });

      if (zubereitung.length === 0) {
        alert('Bitte gib mindestens einen Zubereitungsschritt ein.');
        return;
      }

      // Handle image path
      let bild = document.getElementById('form-bild').value.trim();
      if (bild && !bild.startsWith('http://') && !bild.startsWith('https://')) {
        // Local file - add assets/images/ prefix if not already there
        if (!bild.startsWith('assets/')) {
          bild = 'assets/images/' + bild;
        }
      }

      // Create recipe object
      const recipe = {
        id: editingRecipeId || title.toLowerCase().replace(/[^a-z0-9√§√∂√º√ü]/g, '-').replace(/-+/g, '-'),
        title: title,
        kategorie: document.getElementById('form-kategorie').value,
        bild: bild,
        zeit: document.getElementById('form-zeit').value.trim(),
        portionen: document.getElementById('form-portionen').value.trim(),
        schwierigkeit: document.getElementById('form-schwierigkeit').value,
        beschreibung: document.getElementById('form-beschreibung').value.trim(),
        zutaten: zutaten,
        zubereitung: zubereitung,
        tipps: document.getElementById('form-tipps').value.trim()
      };

      // Check for duplicate ID (only for new recipes)
      if (!editingRecipeId && rezepte.some(r => r.id === recipe.id)) {
        recipe.id = recipe.id + '-' + Date.now();
      }

      // Save to Firebase
      const success = await saveRecipeToFirebase(recipe);

      if (success) {
        if (editingRecipeId) {
          // Update local array
          const index = rezepte.findIndex(r => r.id === editingRecipeId);
          if (index !== -1) {
            rezepte[index] = recipe;
          }
        } else {
          // Add to local array
          rezepte.push(recipe);
        }

        closeModal();
        renderRecipeGrid(rezepte);
        showRecipe(recipe.id);
      }
    }

    // Category filter
    document.querySelectorAll('.category-pill').forEach(pill => {
      pill.addEventListener('click', function() {
        const category = this.dataset.category;

        // Update active state
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        // Filter
        if (category === 'alle') {
          renderRecipeGrid(rezepte);
        } else {
          renderRecipeGrid(rezepte.filter(r => r.kategorie.toLowerCase() === category));
        }
      });
    });

    // Search
    document.getElementById('search').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();

      // Reset category filter
      document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-category="alle"]').classList.add('active');

      if (query === '') {
        renderRecipeGrid(rezepte);
      } else {
        renderRecipeGrid(rezepte.filter(r =>
          r.title.toLowerCase().includes(query) ||
          r.kategorie.toLowerCase().includes(query) ||
          r.beschreibung?.toLowerCase().includes(query)
        ));
      }
    });

    // Close modal on overlay click - only if form is empty
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        const title = document.getElementById('form-title').value.trim();
        if (title && !confirm('Eingabe verwerfen?')) {
          return;
        }
        closeModal();
      }
    });

    // Close modal on Escape key - with confirmation if data entered
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('modal').classList.contains('active')) {
        const title = document.getElementById('form-title').value.trim();
        if (title && !confirm('Eingabe verwerfen?')) {
          return;
        }
        closeModal();
      }
    });

    // Handle browser back button
    window.addEventListener('popstate', function() {
      if (document.getElementById('recipe-view').style.display !== 'none') {
        showHome();
      }
    });

    // Import existing recipes from JSON to Firebase (one-time)
    async function importFromJSON() {
      if (!confirm('Rezepte aus rezepte.json in Firebase importieren?')) return;

      try {
        showNotification('Importiere...', 'success');
        const response = await fetch('rezepte.json');
        const jsonRecipes = await response.json();

        for (const recipe of jsonRecipes) {
          await window.firebaseSetDoc(
            window.firebaseDoc(window.firebaseDB, 'rezepte', recipe.id),
            recipe
          );
        }

        showNotification(`${jsonRecipes.length} Rezepte importiert!`, 'success');
        loadRecipes();
      } catch (error) {
        console.error('Import-Fehler:', error);
        showNotification('Import fehlgeschlagen!', 'error');
      }
    }

    // Week Plan Functions
    const wochentage = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
    let weekPlanRecipes = [];

    function showWeekPlan() {
      if (rezepte.length < 7) {
        alert('Es werden mindestens 7 Rezepte ben√∂tigt f√ºr einen Wochenplan.');
        return;
      }
      generateWeekPlan();
      document.getElementById('week-plan-modal').classList.add('active');
    }

    function closeWeekPlan() {
      document.getElementById('week-plan-modal').classList.remove('active');
    }

    function generateWeekPlan() {
      // Shuffle and pick 7 random recipes
      const shuffled = [...rezepte].sort(() => Math.random() - 0.5);
      weekPlanRecipes = shuffled.slice(0, 7);

      renderWeekPlan();
    }

    function renderWeekPlan() {
      const body = document.getElementById('week-plan-body');
      body.innerHTML = wochentage.map((tag, i) => {
        const recipe = weekPlanRecipes[i];
        return `
          <div class="week-day" onclick="showRecipe('${recipe.id}'); closeWeekPlan();">
            <span class="week-day-name">${tag}</span>
            <span class="week-day-recipe">${recipe.title}</span>
            <span class="week-day-time">${recipe.zeit || ''}</span>
          </div>
        `;
      }).join('');
    }

    function printWeekPlan() {
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Wochenplan</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 40px; max-width: 600px; }
            h1 { font-size: 24px; margin-bottom: 24px; }
            .day { padding: 16px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
            .day-name { font-weight: 600; color: #666; width: 100px; }
            .day-recipe { flex: 1; }
            .day-time { color: #666; }
          </style>
        </head>
        <body>
          <h1>Wochenplan</h1>
          ${wochentage.map((tag, i) => `
            <div class="day">
              <span class="day-name">${tag}</span>
              <span class="day-recipe">${weekPlanRecipes[i].title}</span>
              <span class="day-time">${weekPlanRecipes[i].zeit || ''}</span>
            </div>
          `).join('')}
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    // Close week plan on overlay click
    document.getElementById('week-plan-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeWeekPlan();
      }
    });

    // Initialize
    loadRecipes();
  </script>
  </div><!-- End app-container -->
</body>
</html>
